<div class="d-flex justify-content-between mb-3">
    <div class="btn-group" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-success disabled" id="btn-start"><i class="bi bi-play-fill"></i>
            start</button>
        <button type="button" class="btn btn-danger disabled" id="btn-stop"><i class="bi bi-stop-fill"></i>
            stop</button>
        <button type="button" class="btn btn-danger disabled" id="btn-kill"><i class="bi bi-radioactive"></i>
            kill</button>
        <button type="button" class="btn btn-primary disabled" id="btn-restart"><i class="bi bi-arrow-repeat"></i>
            restart</button>
        <button type="button" class="btn btn-primary disabled" id="btn-pause"><i class="bi bi-pause-fill"></i>
            pause</button>
        <button type="button" class="btn btn-primary disabled" id="btn-resume"><i class="bi bi-play-fill"></i>
            resume</button>
        <button class="btn btn-danger disabled" id="btn-delete"><i class="bi bi-trash-fill"></i>
            delete</button>
    </div>
    <div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#pruneModal">
            <i class="fa-solid fa-tree"></i> prune
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createContainerModal"><i
                class="fa-solid fa-plus"></i></i> container</button>
    </div>

    <!-- Create container modal -->
    <div class="modal fade" id="createContainerModal" tabindex="-1" aria-labelledby="createContainerModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createContainerModalLabel">Create & Run a Container</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="" method="">
                        <div class="mb-3">
                            <label for="image" class="form-label">Image</label>
                            <input type="text" class="form-control" id="image" aria-describedby="imageHelp" required>
                            <div id="imageHelp" class="form-text">If your image is not found on your device, it will be
                                automatically pulled using tage :latest</div>
                        </div>
                        <input type="submit" class="btn btn-success" value="Create" />
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Prune modal -->
    <div class="modal fade" id="pruneModal" tabindex="-1" aria-labelledby="pruneModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createContainerModalLabel">Docker System Prune</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 text-danger">
                        You are about to prune your system, do you wish to continue?
                    </div>
                    <input type="checkbox" class="btn-check" id="btncheck1" autocomplete="off">
                    <label class="btn btn-outline-danger" for="btncheck1">Yes</label>
                    <button type="submit" class="btn btn-danger disabled" id="confirm-prune">prune</button>
                </div>
            </div>
        </div>
    </div>

</div>
<section class="flex-grow-1">
    <table class="table">
        <thead class="table-primary">
            <th><input type="checkbox" id="select-all" class="me-2" />
            </th>
            <th scope="col">Name</th>
            <th scope="col">Short ID</th>
            <th scope="col">Status</th>
            <th scope="col">Image</th>
            <th scope="col">IP</th>
            <th scope="col">Port Binding</th>
            <th scope="col">Actions</th>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div id="loading" style="display: none" class="text-center">
        <div class="spinner-border text-info" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</section>
<section class="position-absolute bottom-0 end-0 w-25 me-3" id="message-container">
</section>
<script>
    $(document).ready(function () {

        $("#spinner").hide();
        $("#loading").show();

        // Get event sources
        var homepageSource = new EventSource('/streaming/homepage');
        var messagesSource = new EventSource('/streaming/messages');

        // Function to close EventSource connections
        // close() calls the call_on_close in server and unsubscribes from topic
        function closeEventSources() {
            homepageSource.close();
            messagesSource.close();
        }

        // Close connections when the page is refreshed or closed
        $(window).on('beforeunload', function () {
            closeEventSources();
        });

        var tbody = $("table tbody");
        var previousState = {};

        homepageSource.onmessage = function (event) {
            var data = JSON.parse(event.data);

            $.each(data, function (i, container) {
                var tr = tbody.find('#row-' + container.Id);
                if (!tr.length) {
                    // If the row does not exist, create it
                    tr = $("<tr>").attr('id', 'row-' + container.Id);
                    tr.append($("<td>").html('<input type="checkbox" class="tr-checkbox" value="' + container.Id + '" name="container"> <span class="spinner-grow spinner-grow-sm row-spinner d-none" role="status" aria-hidden="true"></span>'));
                    tr.append($("<td>").attr('id', 'name-' + container.Id));
                    tr.append($("<td>").attr('id', 'id-' + container.Id));
                    tr.append($("<td>").attr('id', 'status-' + container.Id));
                    tr.append($("<td>").attr('id', 'image-' + container.Id));
                    tr.append($("<td>").attr('id', 'ip-' + container.Id));
                    tr.append($("<td>").attr('id', 'port-' + container.Id));
                    tr.append($("<td>").html('<button class="transparent-btn" onclick="getInfo(\'' + container.Id + '\')"><i class="bi bi-info-circle text-primary"></i></button>' + '<button class="transparent-btn" onclick="getStats(\'' + container.Id + '\')"><i class="bi bi-bar-chart-fill text-primary"></i></button>'));
                    tbody.append(tr);
                }

                // Update the cells with the new data only if it has changed
                if (previousState[container.Id]?.Name !== container.Name) {
                    $('#name-' + container.Id).text(container.Name.substring(1));
                }
                if (previousState[container.Id]?.Id !== container.Id) {
                    $('#id-' + container.Id).text(container.Id.substring(0, 12));
                }
                if (previousState[container.Id]?.State?.Status !== container.State.Status) {
                    $('#status-' + container.Id).html('<span class="badge bg-' + getStatusClass(container.State.Status) + '">' + container.State.Status + '</span>');
                }
                if (previousState[container.Id]?.Config?.Image !== container.Config.Image) {
                    $('#image-' + container.Id).text(container.Config.Image);
                }
                if (previousState[container.Id]?.NetworkSettings?.IPAddress !== container.NetworkSettings.IPAddress) {
                    $('#ip-' + container.Id).text(container.NetworkSettings.IPAddress);
                }
                if (previousState[container.Id]?.HostConfig?.PortBindings !== container.HostConfig.PortBindings) {
                    $('#port-' + container.Id).html(getPortBindings(container.HostConfig.PortBindings));
                }

                // Store the current state of the container for the next update
                previousState[container.Id] = container;
            });

            $("#loading").hide();
        };

        messagesSource.onmessage = function (event) {
            var data = JSON.parse(event.data);
            $('#message-container').append(
                '<div class="alert alert-' + data.category + ' alert-dismissible fade show" role="alert">' +
                data.text +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>'
            );
        };

        // handle prune check box
        $('#btncheck1').change(function () {
            $('#confirm-prune').toggleClass('disabled');
        });

        // handle prune button click
        $('#confirm-prune').on('click', function () {
            // hide prune modal
            $("#pruneModal").modal('hide');
            // uncheck box for next opening of modal
            $("#btncheck1").prop('checked', false);
            $("#confirm-prune").toggleClass('disabled');
            $.ajax({
                url: '/actions/prune',
                method: 'POST',
                success: function (result) {
                },
                error: function (result) {
                    console.error(result);
                }
            })
        })

        // handle select all checkbox change
        $('#select-all').change(function () {
            // select all checkboxes with class of tr-checkbox and make them selected
            $('.tr-checkbox').prop('checked', this.checked);
            // enable/disable buttons
            if (this.checked) {
                $('#btn-stop, #btn-kill, #btn-restart, #btn-pause, #btn-delete, #btn-resume, #btn-start').removeClass('disabled');
            } else {
                // If no checkboxes are checked, disable all buttons
                $('#btn-stop, #btn-kill, #btn-restart, #btn-pause, #btn-delete, #btn-resume, #btn-start').addClass('disabled');
            }
        });
    });

    function getStatusClass(status) {
        switch (status) {
            case "running": return "success";
            case "paused": return "warning";
            case "exited": return "danger";
            default: return "secondary";
        }
    }

    function getPortBindings(portBindings) {
        var result = "";
        $.each(portBindings, function (key, value) {
            $.each(value, function (i, item) {
                result += '<a href="http://localhost:' + item.HostPort + '" target="_blank">' + item.HostPort + ':' + key.split('/')[0] + ' <i class="bi bi-box-arrow-up-right"></i></a> ';
            });
        });
        return result;
    }

    function performAction(url, actionBtnId) {
        // get all container ids that are checked
        var checkedIds = $('.tr-checkbox:checked').map(function () {
            return this.value;
        }).get();

        // diable action button based on actionText
        $('#' + actionBtnId).prop('disabled', true);

        // for each checked row, show the spinner and display the action text
        $('.tr-checkbox:checked').each(function () {
            // disable checkbox
            $(this).hide();
            var row = $(this).closest('tr');
            row.find('.row-spinner').toggleClass('d-none');
        });

        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify({ 'ids': checkedIds }),
            contentType: 'application/json',
            success: function (result) {
                // hide spinners
                $('.tr-checkbox:checked').each(function () {
                    $(this).show();
                    var row = $(this).closest('tr');
                    row.find('.row-spinner').toggleClass('d-none');
                });
                // re-enable all action buttons
                $('#' + actionBtnId).prop('disabled', false);
            }
        });
    }

    $('#btn-delete').click(function () {
        performAction('/actions/delete', 'btn-delete');
    });

    $('#btn-start').click(function () {
        performAction('/actions/start', 'btn-start');
    });

    $('#btn-stop').click(function () {
        performAction('/actions/stop', 'btn-stop');
    });

    $('#btn-kill').click(function () {
        performAction('/actions/kill', 'btn-kill');
    });

    $('#btn-restart').click(function () {
        performAction('/actions/restart', 'btn-restart');
    });

    $('#btn-pause').click(function () {
        performAction('/actions/pause', 'btn-pause');
    });

    $('#btn-resume').click(function () {
        performAction('/actions/resume', 'btn-resume');
    });

</script>